# Fleet HTTP client

A simple wrapper for a c++ rest API client generated by the [OpenAPI Generator](https://openapi-generator.tech). Simplifies functions used to call endpoints of the API. Also limits the amount of requests in case of an error which may cause the API to not wait for new statuses/commands. 

### Request frequency limit

Is only used on getCommands and getStatuses functions. Each time these functions get called, the current time gets added to a container which is then analyzed to find out whether there are too many requests. This needs to be configured by 4 parameters:

- `maxRequestsThresholdCount` max amount of allowed requests in the specified time period
- `maxRequestsThresholdPeriodMs` time period in which the amount of requests is checked
- `delayAfterThresholdReachedMs` time to sleep for in ms when threshold is initially reached
- `retryRequestsDelayMs` delay in ms between requests until request rate is no longer over the threshold

After the initial threshold delay ends, the time container is emptied and subsequent requests are delayed for a shorter time. If the threshold is no longer reached afterwards, the next requests work without any delay as originally.

## Requirements

- cpprestsdk: `sudo apt-get install libcpprest-dev`

## Generating client code

To regenerate the Cpp-rest-openapi-client lib, use the `regen.sh` script. It uses th openapi.yaml file as an input. The most up-to-date version can be found in the [fleet-protocol-http-api project](https://github.com/bringauto/fleet-protocol-http-api).

### Necessary changes

The generated code does not work properly without some adjustments:

- timestamp for Message model needs to be changed to int64_t, otherwise it overflows
- Payload_data needs m_Json added to it store data

This is taken care of by the `regen.sh` script. Changes to the input specification might make it not work, so be careful when generating from new openapi.yaml files.

## Tests

[Tests Readme](./test/README.md)